<!-- templates/chatbot.html -->
{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h1>Chatbot</h1>
  <p class="muted">Ask questions about tools and pain points. Answers are retrieved from indexed Reddit excerpts.</p>

  <div class="chat-container">
    <div class="chat-window" id="chat-window">
      <div class="message bot-message">
        <div class="message-text">Hey there ðŸ‘‹ How can I help?</div>
      </div>
    </div>

    <form id="chat-form" class="chat-form">
      <textarea id="chat-input" class="message-input" placeholder="Type your question..." required></textarea>
      <div class="chat-controls">
        <button type="submit" id="send-message" class="send-btn">Send</button>
      </div>
    </form>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
// Elements
const chatWindow = document.getElementById("chat-window");
const chatForm = document.getElementById("chat-form");
const chatInput = document.getElementById("chat-input");
const sendButton = document.getElementById("send-message");

// Append message (user or bot). content is assumed safe HTML for bot messages.
function appendMessage(content, className = "message user-message", isHtml=false) {
  const div = document.createElement("div");
  div.className = className;
  const inner = document.createElement("div");
  inner.className = "message-text";
  if (isHtml) {
    inner.innerHTML = content;
  } else {
    inner.textContent = content;
  }
  div.appendChild(inner);
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
}

// Show thinking indicator
function showThinking() {
  const div = document.createElement("div");
  div.className = "message bot-message thinking";
  div.innerHTML = `<div class="message-text"><div class="thinking-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>`;
  chatWindow.appendChild(div);
  chatWindow.scrollTop = chatWindow.scrollHeight;
  return div;
}

// Remove thinking indicator
function removeThinking() {
  const t = document.querySelector(".message.bot-message.thinking");
  if (t) t.remove();
}

// Submit handler
async function handleSubmit(e) {
  if (e && typeof e.preventDefault === "function") e.preventDefault();
  const text = (chatInput.value||"").trim();
  if (!text) return false;

  appendMessage(text, "message user-message", false);
  chatInput.value = "";
  chatInput.style.height = "";

  showThinking();

  try {
    const form = new URLSearchParams();
    form.append("msg", text);

    const res = await fetch("/get", { method: "POST", body: form });
    const replyHtml = await res.text();

    removeThinking();

    // If server returned plain text (like "I don't know...") it may not be HTML;
    // we'll heuristically decide: if it contains HTML tags we render as HTML, otherwise render plain text.
    const looksLikeHtml = /<[a-z][\s\S]*>/i.test(replyHtml);
    if (looksLikeHtml) appendMessage(replyHtml, "message bot-message", true);
    else appendMessage(replyHtml, "message bot-message", false);
  } catch (err) {
    removeThinking();
    appendMessage("Error: unable to get response.", "message bot-message", false);
    console.error(err);
  }
  return false;
}

// Hook handlers
chatForm.addEventListener("submit", handleSubmit);

// Enter sends (Shift+Enter newline)
chatInput.addEventListener("keydown", function (e) {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    if (typeof chatForm.requestSubmit === "function") chatForm.requestSubmit();
    else chatForm.dispatchEvent(new Event("submit", { cancelable: true }));
  }
});

// Top send button
if (sendButton) sendButton.addEventListener("click", function (e) {
  e.preventDefault();
  if (typeof chatForm.requestSubmit === "function") chatForm.requestSubmit();
  else chatForm.dispatchEvent(new Event("submit", { cancelable: true }));
});
</script>
{% endblock %}
